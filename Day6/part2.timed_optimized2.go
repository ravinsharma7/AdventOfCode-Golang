package main

import (
	"fmt"
	"runtime"
	"strings"
	"sync"
	"time"
)

type Position struct {
	X, Y int
}

type Direction int

const (
	Up Direction = iota
	Right
	Down
	Left
)

var directions = []Position{
	{-1, 0}, // Up
	{0, 1},  // Right
	{1, 0},  // Down
	{0, -1}, // Left
}

// Parse the input map and ensure it's rectangular
func parseMap(input string) ([][]rune, Position, Direction) {
	lines := strings.Split(strings.TrimSpace(input), "\n")

	// Find the longest line to ensure a rectangular grid
	maxLen := 0
	for _, line := range lines {
		if len(line) > maxLen {
			maxLen = len(line)
		}
	}

	// Pad shorter lines with '.' to ensure all lines have equal length
	for i, line := range lines {
		if len(line) < maxLen {
			line = line + strings.Repeat(".", maxLen-len(line))
		}
		lines[i] = line
	}

	grid := make([][]rune, len(lines))
	var guardPos Position
	var guardDir Direction

	for i, line := range lines {
		grid[i] = []rune(line)
		for j, char := range line {
			switch char {
			case '^':
				guardPos = Position{i, j}
				guardDir = Up
			case '>':
				guardPos = Position{i, j}
				guardDir = Right
			case 'v':
				guardPos = Position{i, j}
				guardDir = Down
			case '<':
				guardPos = Position{i, j}
				guardDir = Left
			}
		}
	}

	return grid, guardPos, guardDir
}

// Simulate the guard's patrol with an optional obstruction
func simulateWithObstruction(grid [][]rune, guardPos Position, guardDir Direction, obstruction Position) bool {
	rows := len(grid)
	cols := len(grid[0])

	// visited[x][y][dir]
	visited := make([][][]bool, rows)
	for i := range visited {
		visited[i] = make([][]bool, cols)
		for j := range visited[i] {
			visited[i][j] = make([]bool, 4)
		}
	}

	for {
		if visited[guardPos.X][guardPos.Y][guardDir] {
			return true // Loop detected
		}
		visited[guardPos.X][guardPos.Y][guardDir] = true

		nextPos := Position{
			X: guardPos.X + directions[guardDir].X,
			Y: guardPos.Y + directions[guardDir].Y,
		}

		if nextPos.X < 0 || nextPos.X >= rows || nextPos.Y < 0 || nextPos.Y >= cols {
			break
		}

		// Treat the obstruction cell as blocked if it matches nextPos
		blocked := (nextPos.X == obstruction.X && nextPos.Y == obstruction.Y) || (grid[nextPos.X][nextPos.Y] == '#')

		if blocked {
			guardDir = (guardDir + 1) % 4
		} else {
			guardPos = nextPos
		}
	}

	return false
}

// Find valid obstruction positions in parallel
func findValidObstructions(grid [][]rune, guardPos Position, guardDir Direction) int {
	rows := len(grid)
	cols := len(grid[0])
	var validCount int
	var wg sync.WaitGroup
	mutex := &sync.Mutex{}

	// Use all available CPU cores
	runtime.GOMAXPROCS(runtime.NumCPU())

	// Divide work into chunks for parallel processing
	chunkCount := 4
	chunkSize := (rows + chunkCount - 1) / chunkCount

	for startRow := 0; startRow < rows; startRow += chunkSize {
		endRow := startRow + chunkSize
		if endRow > rows {
			endRow = rows
		}

		wg.Add(1)
		go func(start, end int) {
			defer wg.Done()
			localCount := 0

			for x := start; x < end; x++ {
				for y := 0; y < cols; y++ {
					// Only consider '.' cells that are not the guard's initial position
					if grid[x][y] == '.' && !(x == guardPos.X && y == guardPos.Y) {
						if simulateWithObstruction(grid, guardPos, guardDir, Position{x, y}) {
							localCount++
						}
					}
				}
			}

			mutex.Lock()
			validCount += localCount
			mutex.Unlock()
		}(startRow, endRow)
	}

	wg.Wait()
	return validCount
}

func main() {
	input := `
#.............#.#...........................................................#..........#...........................#..........#...
............#......................#.......#..#.........#...................##....................................................
..............#...........#..#.......#.........#.#...........................#................................#......#............
.....#......................................#......#..#...................#....................#......................#...........
...#............................#................................#................................................................
..........#..................#.....#......................................................#.......................................
..#........#.......#.#...............................................................#......#.................................#...
.#....#................#................#.....#...................#...............................................#..#............
.......................................................................................#...#.#....#........##......#........#.#.##
............................................#.................#.....................#..........................#..................
....#..........##......................#.................................................................................#........
......#.............##.........#.......#.........#.......#.............#...#.......#..............................................
.#............................................................................#..........#....#...................................
...#..#....#..............................#...........................................................................#...........
.............#....................................................................................................................
................................#..................##...................................#...............................#......#..
..........#.........#.................#..........###...........................................#............#...#.................
.............#....................................#.......#.#.#............#............................................#.........
......#.#..............................................................................................#.........................#
...#...#.........#.........#..#......#................##.................#........................................................
.................................#......................#........#................#........................#......................
.......................##..............#................#................#..............................#.........................
.......#...#.....#.....##........................#..................##.....#......................................................
.............................................#...........................#..........................................#.....#.......
.........................#...............#....#..............#.......#...............#.#.................#.................#......
...........................................................#....#..................................#..............................
..........................#.................................................#............................##....#..................
.................#...#.........................................................#........................#.....#..#................
.........................#....#................................................#...#.....................#....#...........#.......
................................................##.......#.#....................................#.......##........................
..........##...#.......................#....#..#....................#........................#....................................
#......#.......................#............#.....................................................................#...............
.......#.......#...#..#..........#.......................................#.............#......#...................................
...............#............#..................#.................................................................................#
.......#...........#.......................##.....#.........#...........#...................#......#.........#.............##....#
...................#.........................#......#..........................................#..........#.........#......#......
.....#............#..............#...#......#....................#.............#..................................................
................................................#........#.....#...................#.....................................#.....#..
......................#.#...##......................##...............................................#.................#..........
#...................#.........................#...........#.....#................#.....................#...................#......
....#................#.....#.............#.....................................#....#...#.................................#.......
.........#.....................................................................................................#.#.......#........
.........#..........##..............................#............................#.#.............................#................
#....#.#..............................................##...#...#...............#.............#....................................
........#..#.#...................#.......................................................................#.............#..#.#...#.
.................................................................................................................#.......#........
............................................#..#...............##........#..........#.......................................#....#
........#...........................#............................#.....#........................#..........#...#..........#.......
.#...........#...................................................#...........................................#................#.#.
............#...............................#........#...........#..........#...........#.#..............#........................
...............................................................................##.#................#..............................
.#.......................#.#...........#..................................#.......................................................
..#..............................................##................#.......#....#..............#.....................#...#........
...................#.....#................................................#..........#.........#.........#.....................#..
........#................#................................................................................#......#................
...................#...#....#.........................#.........................#....................#..........................#.
.................#.......................................................#................................................#.......
..#...........................##.#.............#..#............................................#.......................#.#........
..#......#.........................................................................#.......................#......................
...........................................................................................................#............#......#..
............................................................^..........................................#..........#...............
..#.........#....................#..........................................#........#.........................................#..
........#...............#....#.............#......#.........................................................................#.....
.........#......#.....#..............#...........................................................#..............#.................
.........#...................................................#...###...........#.......#.##.......................................
.....................##.................#.........##.....................#................#................#.........#............
.......................................................................#..............#..............#.................#..........
.##.........#..........................................................................#....................................#.....
.........................#.............................#........................................................................#.
........#.............................................#......#....#.....................................#....................#....
........#...#..............................................................................#.........#............................
..............................#................................#..........#..............#..................................#.....
........##..#...................................#................................#.................#.........#......#..#........#.
..................#......#...................................................................#....................................
..........#.............#..............#........#............#...............#..#..........#..............#.#...#............#....
............................##....#..............#......................................................................#.........
...............................................#.....#...........#.....##...............#..#......................................
.........................#.......#...............................#...........#.........#...........#....#.........................
.#............#...#...............#..............................................................#..........................#....#
#...........#......................................................#.............................#......#.........................
..................................................#....#...............#.........................#................................
................................................#..........................#.......#..............................#....##.......#.
........#......#..#............#................#............................#......#.##.........#....................#..#........
.......................................................#..#.#....................#..#......................................#......
.....................#.......................................................................#............#.......................
.....................##........................#...................#.....................#........................................
..........................#...........................................................................................#...........
..#..........#...................#..............##..#.....................#...................#..............#...........#........
#................................#....##......#.............#..............#.......................#.........#...........#........
..................#................#...............................#.....#..........#................#..............#.............
................#.#.........#.....##...............................................................#..............#...............
..#...............................................................................................#...............................
..........#.................#...........#.......#.........................#...#.......#...........................................
..##....#......................................#.#.......................................#.................#......................
.......................#..#...#.##......................................................................#.........#...#...........
...............#.........#..............#.....................................................#...................#...............
......#.................#............#......#...................#..#.........................#........................#........#..
......................................................................#...........................#........#......................
..........#..........#........................#.............##....................................................................
....#................................................#.......................#................#...............#...................
.................#....................................................#......#....................................................
.#........#.......................................................................................................................
......##..................#....#......#.................#....................#.....................#..#...........#...............
#...#...#...#..............#........#.......................#.#..........#...............................#......#.................
#...#...................#.............#........#..........#...............................................................#...#...
..#................................#...#.........................#...................#......#.....................................
...#...###..........#............#...............................................................#..........#.....................
............#..............#.......#.....#..........#.....#.........................................................#............#
..#......................#..#...#................................#......#.......#.....#..................#.........#..............
....##......#.......................................................#..............................................#..............
...............................#.....#....#.................................................#.......#............#................
..........#....#......................#........#..........................#......#................................................
......#.............................#...........#..................#...........................#................................#.
...........................##..........................................#.....#.#.....................#................#...........
..#..............#.........................................................#........................#.........#.................#.
#.....#.....#......................#....................#........................................#...........#...........#......#.
.......................................#..#................................#.........#.......#..#.....#..........................#
..........#..............##...............#..........................................................#......#......#......#....#..
.............#..............#..#......#........#..#......##.......................#...........#.......#...........................
......................#.......................................#.......#..#.....................................#.........#...##...
...........................#...........................#......#....#.............................#.............................#..
..................#............................#....#........##.........................#..............#.............#............
.......#....................#.....#........#.......#.#...#...............#.....#.#.........................#.......#.#............
.....#.........#.......#..........#.................#..#...#..................................................##..................
................#........................................................#........................................................
....##......#........#..................#.........................#...................................#...#...................#...
..............#....................#.......#.......................#.............#......#..............#..........................
...........................#..............#.....#............#.....................#........#....#.......................#........
........#..##................#.....#.#..............#..............................#........................#.........#...........
.........................................................#...........................##..........#........#.##....................
`

	// Start the timer
	start := time.Now()

	// Parse the map and calculate valid obstructions
	grid, startPos, startDir := parseMap(input)
	result := findValidObstructions(grid, startPos, startDir)

	// Stop the timer
	elapsed := time.Since(start)

	// Display the results
	fmt.Printf("Number of valid obstruction positions: %d\n", result)
	fmt.Printf("Execution time: %s\n", elapsed)
	fmt.Printf("Execution time (nanoseconds): %d ns\n", elapsed.Nanoseconds())
	fmt.Printf("Execution time (microseconds): %.3f µs\n", float64(elapsed.Nanoseconds())/1000)
	fmt.Printf("Execution time (milliseconds): %.3f ms\n", float64(elapsed.Nanoseconds())/1_000_000)
}
